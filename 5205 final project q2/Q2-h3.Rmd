---
title: "5205 final prj Q2 h3"
author: "ZiYan Cui"
date: "4/19/2023"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, message = F, results = "hide", warning=FALSE}
setwd("C:/Users/Roger/Desktop")
library(tidyverse)
library(tm)
library(tidytext)
library(stringr)
library(dplyr)
library(wordcloud)
library(tidyr); library(ggplot2); library(ggthemes)
library(grid)
library(gridExtra)
disneyland<- disneyland <- read_csv("disneyland.csv")
rides <- read_csv('rides.csv')
```


# Research Question 2       


## Hypothesis 3:  
H0: Regarding to ride experiences, reviewers visit different branches tend to give similar reviews and ratings.  
Ha: Regarding to ride experiences, reviewers visit different branches tend to give different reviews and ratings.            

### Get ride names                
```{r, warning=FALSE}
rides_name <- rides$Ride_name
rides_name
```
```{r, warning=FALSE}
#rides_name[1:14]
disneyland_ride <- disneyland %>%
  mutate(Astro_Orbiter = case_when(grepl(c("astro orbiter", "Astro", "Orbiter"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Avatar_Flight = case_when(grepl(c("Avatar Flight of Passage", "Avatar Flight", "Avatar Ride"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Big_Thunder = case_when(grepl(c("Big Thunder Mountain Railroad", "Big Thunder"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Buzz_Lightyear = case_when(grepl(c("Buzz Lightyear's Space Ranger Spin", "Buzz Lightyear's", "Space Ranger Spin", "Space Ranger"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Dinosaur = case_when(grepl(c("Dinosaur"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Dumbo = case_when(grepl(c("Dumbo the Flying Elephant", "Flying Elephant"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Expedition_Everest = case_when(grepl(c("Expedition Everest"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Frozen_Ever = case_when(grepl(c("Frozen Ever After", "Ever After"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Gran_Fiesta = case_when(grepl(c("Gran Fiesta Tour Starring The Three Caballeros", "Gran Fiesta", "Starring The Three Caballeros", "Three Caballeros"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Haunted_Mansion = case_when(grepl(c("Haunted Mansion"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Small_World= case_when(grepl(c("It's a Small World", "Small World"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Journey_Into= case_when(grepl(c("Journey Into Imagination with Figment", "Imagination with Figment"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Jungle_Cruise= case_when(grepl(c("Jungle Cruise"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Kali_River = case_when(grepl(c("Kali River Rapids", "Kali River"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0))
```
```{r, warning=FALSE}
#rides_name[15:28]
disneyland_ride <- disneyland_ride %>%
  mutate(Kilimanjaro_Safaris = case_when(grepl(c("Kilimanjaro Safaris", "Kilimanjaro"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Living_With = case_when(grepl(c("Living with the Land"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Mad_Tea = case_when(grepl(c("Mad Tea Party", "Mad Tea"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Mission_Space = case_when(grepl(c("Mission Space"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Navi_River = case_when(grepl(c("Na'vi River Journey", "Na'vi"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Peter_Pan = case_when(grepl(c("Peter Pan's Flight", "Peter Pan's"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Pirates = case_when(grepl(c("Pirates of the Caribbean", "Pirates", "Caribbean"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Primeval_Whirl = case_when(grepl(c("Primeval Whirl"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Prince_Charming = case_when(grepl(c("Prince Charming Regal Carrousel", "Regal Carrousel"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Rock_Roller = case_when(grepl(c("Rock 'n' Roller Coaster", "Rock n"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Seven_Dwarfs = case_when(grepl(c("Seven Dwarfs Mine Train", "Mine Train"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Soarin_Around = case_when(grepl(c("Soarin' Around the World", "Soaring Around", "Soarin' Around"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Space_Mountain = case_when(grepl(c("Space Mountain"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Spaceship_Earthn = case_when(grepl(c("Spaceship Earth"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0))
```
```{r, warning=FALSE}
#rides_name[29:42]
disneyland_ride <- disneyland_ride %>%
  mutate(Splash_Mountain = case_when(grepl(c("Splash Mountain"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Star_Tours = case_when(grepl(c("Star Tours"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Test_Track = case_when(grepl(c("Test Track"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Barnstormer = case_when(grepl(c("The Barnstormer"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Magic_Carpets = case_when(grepl(c("The Magic Carpets of Aladdin", "Magic Carpets"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Winnie_Pooh = case_when(grepl(c("The Many Adventures of Winnie the Pooh", "Many Adventures of Winnie"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Twilight_Zone = case_when(grepl(c("The Twilight Zone Tower of Terror", "Twilight Zone", "Tower of Terror"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Tomorrowland_Speedway = case_when(grepl(c("Tomorrowland Speedway"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Tomorrowland_Transit = case_when(grepl(c("Tomorrowland Transit Authority PeopleMover", "Transit Authority"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Toy_Story = case_when(grepl(c("Toy Story Mania"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(TriceraTop_Spin = case_when(grepl(c("TriceraTop Spin", "Tricera Top"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(Under_Sea = case_when(grepl(c("Under the Sea"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>%
  mutate(World_Railroad = case_when(grepl(c("Walt Disney World Railroad", "Disney World Railroad"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0)) %>% 
  mutate(Carousel_Progress = case_when(grepl(c("Walt Disney's Carousel of Progress", "Carousel of Progress"), Review_Text, ignore.case = TRUE) ~ 1, 
                                   TRUE ~ 0))
```

Because some of the rides only exists in the Orlando Disney, so we want to exclude the column associated with rides not being mentioned in any of the `Review_Text`.
```{r, warning=FALSE}
# rides mentioned in the Disneyland dataset: 27-3 = 24 rides. There are 40043 reviews. dropped other columns
disneyland_ride2 <- disneyland_ride %>% 
  select_if(function(x) !all(x == 0)) %>% 
  select(c(2,6,9,11:34))

# disneyland_ride2: 3 basic info + 24 rides + 2 mention columns. 29 cols, 40043 reviews
disneyland_ride2$mention_ride <-  ifelse(rowSums(disneyland_ride2[c(4:27)]) == 0, 0, 1)
disneyland_ride2$no_mention_ride <-  ifelse(rowSums(disneyland_ride2[c(4:27)]) == 0, 1, 0)
head(disneyland_ride2)
```             


Split dataset based on branch for those mentioned at least one ride
```{r, warning=FALSE}
# also remove ride columns that are not in branch
hongkong <- disneyland_ride2 %>%
  filter(Branch == 'Disneyland_HongKong') %>% 
  select_if(function(x) !all(x == 0))     # HK: 1:3(info) + 4:19(16 rides) + 20:21(mention cols)
cali <- disneyland_ride2 %>%
  filter(Branch == 'Disneyland_California') %>% 
  select_if(function(x) !all(x == 0))     # CA: 1:3(info) + 4:23(20 rides) + 24:25(mention cols)
paris <- disneyland_ride2 %>%
  filter(Branch == 'Disneyland_Paris') %>% 
  select_if(function(x) !all(x == 0))     # PR: 1:3(info) + 4:20(17 rides) + 21:22(mention cols)
```               
We structured the columns to be: 3 columns of basic information, ride dummy variables, and 2 columns indicating whether the line of the review mentioned rides or not.  
`hongkong`: 3 info + 16 rides + 2 mention columns for Hong Kong  
`cali`:     3 info + 20 rides + 2 mention columns for California  
`paris`:    3 info + 17 rides + 2 mention columns for Paris  


### HK                

```{r}
head(hongkong)
rides_hk = data.frame(rd=names(colSums(hongkong[c(4:21)])))
rides_hk       # HK: 4:19(16 rides) + 20:21(2 mention cols)

colSums(hongkong[c(4:21)])

# get the avg rating for each ride
df <- data.frame()
for (i in 1:nrow(rides_hk)) { 
  for (k in rides_hk[i,]) { 
    avg_rating <- hongkong %>%
        filter(hongkong[,k] != 0) %>%
        summarise(avg_rating = mean(Rating))
    df <- rbind(df, avg_rating)
  } 
}

# ride names, counts, and average ratings
ride_mention_count <- data.frame(rides = names(colSums(hongkong[c(4:21)])), 
                                 counts = as.numeric(colSums(hongkong[c(4:21)])),
                                 avg_raing = df)

# Frequency of each ride in total branch reviews & in reviews that mentioned rides in the branch
freq_all <- ride_mention_count %>%
  mutate(freq_branch_pct = counts/nrow(hongkong)*100, 
         freq_Mention_pct = counts/counts[17]*100) %>%
  mutate_at(c(3:5), round, digits = 2)%>%
  arrange(desc(freq_Mention_pct)) 
freq_all
```




```{r}
# proportions of reviews that mentioned rides & no mention rides in the branch
p_mention_orno <- freq_all[1:2, 1:4]
p_mention_orno    

p_mention_orno%>%
  ggplot(aes(x="", y=freq_branch_pct, fill=rides)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  labs(fill = "Ride Experience Mentioned") +
  ggtitle("Reviews that mentioned & did not mention ride experiences in Hong Kong") +
  theme_void()+
  geom_text(aes(label = paste0(freq_branch_pct, "%")), position = position_stack(vjust=0.5)) +
  scale_fill_manual(values=c("#F1786C", "#E8CCC7"), 
                    labels=c("Mentioned", "Did not mention"))
```               
      
      
88.98% did not mention ride experiences in HK branch with an average rating of 4.21; 11.02% mentioned ride experiences in HK branch with a slightly higher average rating of 4.26.  


```{r, warning=FALSE, fig.width=12, fig.height=6}
# proportions of rides mentioned in the branch
# over total number of reviews in the branch & over reviews that mentioned rides in branch
p_rides <- freq_all[3:18, 1:5]

# filter freqs >= 2% of the reviews that mentioned rides in the branch, rating high to low
hot_rides <- p_rides %>%
  filter(freq_Mention_pct >= 2) 
hot_rides



# 
ride_rank_plot <- hot_rides%>%
  ggplot(aes(x=reorder(rides,freq_Mention_pct), 
             y=freq_Mention_pct, fill=freq_Mention_pct))+
  geom_col(position='dodge')+
  coord_flip()+
  labs(x = "", y = "Frequency in %") +
  ggtitle("All rides mentioned in Hong Kong with % distribution")+
  scale_fill_gradient(low = "#FCDADA", high = "#C50F0F", guide = FALSE) +
  theme(plot.background = element_blank(), 
        panel.background = element_blank(), 
        panel.grid.major.x  = element_line(color = "light grey"),
        axis.line = element_line(color = "black"),
        plot.title = element_text(size = 15, hjust = -0.267, vjust = 1)) 

# rating  
rating_rank_plot <- hot_rides %>%
  ggplot() +
  geom_col(aes(x=reorder(rides, -avg_rating), y=freq_Mention_pct, fill=freq_Mention_pct), 
           width=0.7, position='dodge')+  
  scale_y_continuous(name = "Frequency in %", 
                     expand = c(0,0),
                     limits = c(-10, 80)) +
  geom_text(aes(x=rides, y=-5, label=avg_rating), size = 4.5) +
  labs(x = "Mostly mentioned rides", y = "Frequency in %") +
  ggtitle("Average rating ranked with popular rides & no ride") +
  scale_fill_gradient(low = "#FCDADA", high = "#C50F0F", guide = FALSE)+
  labs(tag ="Ratings:")+  
  theme(plot.background = element_blank(), 
        panel.background = element_blank(), 
        panel.grid.major.y  = element_line(color = "light grey"),
        axis.line = element_line(color = "black"),
        plot.tag.position = c(0.01,0.115),
        plot.tag = element_text(hjust = 0, size=12.5),
        plot.title = element_text(size = 15)) + 
  geom_vline(xintercept = 5.5, linetype = "dashed") +
  geom_text(aes(label = "No rides mentioned", x = 5.5, y=50), angle = 45, color = "#7C7C7C", size = 4)+
  geom_text(aes(label = "4.21", x = 5.5, y=-5), size = 4)



grid.arrange(ride_rank_plot, rating_rank_plot, ncol = 2)
```               
From the plot above, We can see that the mostly mentioned ride in Hong Kong branch is Space_Mountain ride, following by Small_World and Haunted_Mansion. Reviews who mentioned Small_World, Haunted_Mansion, and Star_Tours tend to give higher ratings on average. Space_Mountain, the ride that significantly more people mentioned about, obtained an average ratings that is only slightly higher than those that did not mention any rides. Pirates ride received lower rating than those did not mention rides, which might suggest that visitors might have bad impressions on this ride and caused them to leave a relatively neutral or negative ratings.  





### CA                

```{r}
head(cali)
rides_ca = data.frame(rd=names(colSums(cali[c(4:25)])))
rides_ca   # CA: 1:3(info) + 4:23(20 rides) + 24:25(2 mention cols)

colSums(cali[c(4:25)])

# get the avg rating for each ride
df <- data.frame()
for (i in 1:nrow(rides_ca)) { 
  for (k in rides_ca[i,]) { 
    avg_rating <- cali %>%
        filter(cali[,k] != 0) %>%
        summarise(avg_rating = mean(Rating))
    df <- rbind(df, avg_rating)
  } 
}

# ride names, counts, and average ratings
ride_mention_count <- data.frame(rides = names(colSums(cali[c(4:25)])), 
                                 counts = as.numeric(colSums(cali[c(4:25)])),
                                 avg_raing = df)

# Frequency of each ride in total branch reviews & in reviews that mentioned rides in the branch
freq_all <- ride_mention_count %>%
  mutate(freq_branch_pct = counts/nrow(cali)*100, 
         freq_Mention_pct = counts/counts[21]*100) %>%
  mutate_at(c(3:5), round, digits = 2)%>%
  arrange(desc(freq_Mention_pct)) 
freq_all
```

```{r}
# proportions of reviews that mentioned rides & no mention rides in the branch
p_mention_orno <- freq_all[1:2, 1:4]
p_mention_orno    

p_mention_orno%>%
  ggplot(aes(x="", y=freq_branch_pct, fill=rides)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  labs(fill = "Ride Experience Mentioned") +
  ggtitle("Reviews that mentioned & did not mention ride experiences in California") +
  theme_void()+
  geom_text(aes(label = paste0(freq_branch_pct, "%")), position = position_stack(vjust=0.5)) +
  scale_fill_manual(values=c("#19B34C", "#D6F1DF"), 
                    labels=c("Mentioned", "Did not mention"))
```               
      
      
83.08% did not mention ride experiences in CA branch with an average rating of 4.43; 16.92% mentioned ride experiences in CA branch with a slightly lower average rating of 4.36. This finding is different from What we had in HK branch, where the average rating is slightly higher for reviews that mentioned raide experiences.   



```{r, warning=FALSE, fig.width=12, fig.height=6}
# proportions of rides mentioned in the branch
# over total number of reviews in the branch & over reviews that mentioned rides in branch
p_rides <- freq_all[3:22, 1:5]

# filter freqs >= 2% of the reviews that mentioned rides in the branch, rating high to low
hot_rides <- p_rides %>%
  filter(freq_Mention_pct >= 2) 
hot_rides



#  
ride_rank_plot <- hot_rides%>%
  ggplot(aes(x=reorder(rides,freq_Mention_pct), 
             y=freq_Mention_pct, fill=freq_Mention_pct))+
  geom_col(position='dodge')+
  coord_flip()+
  labs(x = "", y = "Frequency in %") +
  ggtitle("All rides mentioned in California with % distribution")+
  scale_fill_gradient(low = "#D6F1DF", high = "#19B34C", guide = FALSE) +
  theme(plot.background = element_blank(), 
        panel.background = element_blank(), 
        panel.grid.major.x  = element_line(color = "light grey"),
        axis.line = element_line(color = "black"),
        plot.title = element_text(size = 15, hjust = -0.267, vjust = 1)) 

# 
rating_rank_plot <- hot_rides %>%
  ggplot() +
  geom_col(aes(x=reorder(rides, -avg_rating), y=freq_Mention_pct, fill=freq_Mention_pct), 
           width=0.7, position='dodge')+  
  scale_y_continuous(name = "Frequency in %", 
                     expand = c(0,0),
                     limits = c(-10, 80)) +
  geom_text(aes(x=rides, y=-5, label=avg_rating), size = 4.5) +
  labs(x = "Mostly mentioned rides", y = "Frequency in %") +
  ggtitle("Average rating ranked with popular rides & no ride") +
  scale_fill_gradient(low = "#D6F1DF", high = "#19B34C", guide = FALSE)+
  labs(tag ="Ratings:")+  
  theme(plot.background = element_blank(), 
        panel.background = element_blank(), 
        panel.grid.major.y  = element_line(color = "light grey"),
        axis.line = element_line(color = "black"),
        plot.tag.position = c(0.01,0.108),
        plot.tag = element_text(hjust = 0, size=12.5),
        plot.title = element_text(size = 15)) + 
  geom_vline(xintercept = 3, linetype = "dashed") +
  geom_text(aes(label = "No rides mentioned", x = 3, y=50), angle = 45, color = "#7C7C7C", size = 4)+
  geom_text(aes(label = " ", x = 5.5, y=-5), size = 5)



grid.arrange(ride_rank_plot, rating_rank_plot, ncol = 2)
```               
From the plot above, We can see that the mostly mentioned ride in California branch is also Space_Mountain ride, which is the same as in Hong Kong branch, following by Splash_Mountain and Haunted_Mansion. However, when it comes to average ratings, we found that in California, rides that people tend to mention more about did not lead to higher ratings. The rating even tend to be lower than those did not mention any rides. The mostly mentioned ride, Space_Mountain, received an average rating of 4.37. Although this average rating is slightly higher than the same ride in Hong Kong branch, it is even lower than the ratings that did not mention rides in California. This might suggest that consumers are not entirely happy about their general ride experiences.  





### PR                


```{r}
head(paris)
rides_pr = data.frame(rd=names(colSums(paris[c(4:22)])))
rides_pr    # PR: 4:20(17 rides) + 21:22(2 mention cols)

colSums(paris[c(4:22)])

# get the avg rating for each ride
df <- data.frame()
for (i in 1:nrow(rides_pr)) { 
  for (k in rides_pr[i,]) { 
    avg_rating <- paris %>%
        filter(paris[,k] != 0) %>%
        summarise(avg_rating = mean(Rating))
    df <- rbind(df, avg_rating)
  } 
}

# ride names, counts, and average ratings
ride_mention_count <- data.frame(rides = names(colSums(paris[c(4:22)])), 
                                 counts = as.numeric(colSums(paris[c(4:22)])),
                                 avg_raing = df)

# Frequency of each ride in total branch reviews & in reviews that mentioned rides in the branch
freq_all <- ride_mention_count %>%
  mutate(freq_branch_pct = counts/nrow(paris)*100, 
         freq_Mention_pct = counts/counts[18]*100) %>%
  mutate_at(c(3:5), round, digits = 2)%>%
  arrange(desc(freq_Mention_pct)) 
freq_all
```

```{r}
# proportions of reviews that mentioned rides & no mention rides in the branch
p_mention_orno <- freq_all[1:2, 1:4]
p_mention_orno
#                 avg_rating  frequency %
# HK: no_mention:   4.21        88.98
#     mentioned:    4.26        11.02
# CA: no_mention:   4.43        83.08   
#     mentioned:    4.36        16.92


p_mention_orno%>%
  ggplot(aes(x="", y=freq_branch_pct, fill=rides)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  labs(fill = "Ride Experience Mentioned") +
  ggtitle("Reviews that mentioned & did not mention ride experiences in Paris") +
  theme_void()+
  geom_text(aes(label = paste0(freq_branch_pct, "%")), position = position_stack(vjust=0.5)) +
  scale_fill_manual(values=c("#4169E2", "#BACBFF"), 
                    labels=c("Mentioned", "Did not mention"))
```               
      
      
84.63% did not mention ride experiences in PR branch with an average rating of 3.98; 15.37% mentioned ride experiences in PR branch with a very similar average rating of 3.97. Comparing to the two branches before, the two average ratings are much lower than in HK and CA. This might suggest that Paris branch receive generally lower ratings compared to other branches. The proportions of rides mentioned in the review text verses did not are  similar compared to other two branches. 


```{r, warning=FALSE, fig.width=12, fig.height=6}
# proportions of rides mentioned in the branch
# over total number of reviews in the branch & over reviews that mentioned rides in branch
p_rides <- freq_all[3:19, 1:5]

# filter freqs >= 2% of the reviews that mentioned rides in the branch, rating high to low
hot_rides <- p_rides %>%
  filter(freq_Mention_pct >= 2) 
hot_rides



# 
ride_rank_plot <- hot_rides%>%
  ggplot(aes(x=reorder(rides,freq_Mention_pct), 
             y=freq_Mention_pct, fill=freq_Mention_pct))+
  geom_col(position='dodge')+
  coord_flip()+
  labs(x = "", y = "Frequency in %") +
  ggtitle("All rides mentioned in Paris with % distribution")+
  scale_fill_gradient(low = "#D4DFFF", high = "#083DDC", guide = FALSE) +
  theme(plot.background = element_blank(), 
        panel.background = element_blank(), 
        panel.grid.major.x  = element_line(color = "light grey"),
        axis.line = element_line(color = "black"),
        plot.title = element_text(size = 15, hjust = -0.267, vjust = 1)) 

# 
rating_rank_plot <- hot_rides %>%
  ggplot() +
  geom_col(aes(x=reorder(rides, -avg_rating), y=freq_Mention_pct, fill=freq_Mention_pct), 
           width=0.7, position='dodge')+  
  scale_y_continuous(name = "Frequency in %", 
                     expand = c(0,0),
                     limits = c(-10, 80)) +
  geom_text(aes(x=rides, y=-5, label=avg_rating), size = 4.5) +
  labs(x = "Mostly mentioned rides", y = "Frequency in %") +
  ggtitle("Average rating ranked with popular rides & no ride") +
  scale_fill_gradient(low = "#D4DFFF", high = "#083DDC", guide = FALSE)+
  labs(tag ="Ratings:")+  
  theme(plot.background = element_blank(), 
        panel.background = element_blank(), 
        panel.grid.major.y  = element_line(color = "light grey"),
        axis.line = element_line(color = "black"),
        plot.tag.position = c(0.01,0.115),
        plot.tag = element_text(hjust = 0, size=12.5),
        plot.title = element_text(size = 15)) + 
  geom_vline(xintercept = 3.5, linetype = "dashed") +
  geom_text(aes(label = "No rides mentioned", x = 3.5, y=70), angle = 30, color = "#7C7C7C", size = 4)+
  geom_text(aes(label = "3.98", x = 3.5, y=-5), size = 4)

grid.arrange(ride_rank_plot, rating_rank_plot, ncol = 2)
```               
The mostly mentioned ride in Paris branch is also Space_Mountain ride, following by Pirates and Star_Tours. As mentioned before, the general rating for Paris branch is much lower than other two branches. This is also true for the reviews regardless of mentioning or not mentioning ride experiences. Peter_Pan and Small_World received similarly higher average ratings, following by Space_Mountain. Reviewers who did not mention any ride rated slightly higher on average than other rides including Pirates, Star_Tours, and Haunted Mansion. This might suggest that apart from Peter_Pan and Small_World, rides that are most frequently mentioned in Paris branch might tend to receive more neutral ratings. People tend not to give higher ratings when they mention rides that are popular or mostly mentioned compared with the ratings without mentioning rides, in which case, these most mentioned rides tend not to be more favorable among visitors.  
 


## Sentiment Analysis
### Hong Kong
```{r}
afinn = get_sentiments('afinn')
```

Integrate the three branches and attach to original dataset
```{r}
# rbind all 3 branches 
tri_branch <- rbind(hongkong[,20:21], cali[,24:25], paris[,21:22])
# cbind indicators to original dataset
disneyland <- cbind(disneyland, tri_branch)
```

Distribution of sentiment scores with ride experience
```{r message=FALSE, warning=FALSE}
dis_w_shop <- disneyland %>%
  filter(Branch == 'Disneyland_HongKong', mention_ride == 1) %>%
  select(Review_ID,Review_Text)%>%
  group_by(Review_ID)%>%
  unnest_tokens(output=word,input=Review_Text)%>%
  inner_join(afinn)

agg_data <- aggregate(dis_w_shop[, 'value'], by = list(dis_w_shop$Review_ID), FUN = function(x) mean(x))

colnames(agg_data) <- c("Review_ID", "mean_value")
agg_data %>%
  ggplot(aes(x=mean_value,fill=mean_value>0))+
  geom_histogram(binwidth = 0.1)+
  scale_x_continuous(breaks=seq(-5,5,1))+
  scale_fill_manual(values=c('tomato','seagreen'))+
  theme_bw() +
  labs(x = "Review Sentiment Scores", y = "Number of Reviews") +
  ggtitle("Distribution of Review Sentiment in Hongkong Branch (contain ride experience)")


```

Distribution of sentiment scores without ride experience
```{r message=FALSE, warning=FALSE}
dis_wt_shop <- disneyland %>%
  filter(Branch == 'Disneyland_HongKong', mention_ride == 0) %>%
  select(Review_ID,Review_Text)%>%
  group_by(Review_ID)%>%
  unnest_tokens(output=word,input=Review_Text)%>%
  inner_join(afinn)
agg_data <- aggregate(dis_wt_shop[, 'value'], by = list(dis_wt_shop$Review_ID), FUN = function(x) mean(x))

colnames(agg_data) <- c("Review_ID", "mean_value")
agg_data %>%
  ggplot(aes(x=mean_value,fill=mean_value>0))+
  geom_histogram(binwidth = 0.1)+
  scale_x_continuous(breaks=seq(-5,5,1))+
  scale_fill_manual(values=c('tomato','seagreen'))+
  theme_bw() +
  labs(x = "Review Sentiment Scores", y = "Number of Reviews") +
  ggtitle("Distribution of Review Sentiment in Hongkong Branch (not contain ride experience)")

```

### California
Distribution of sentiment scores with ride experience
```{r message=FALSE, warning=FALSE}
dis_w_shop <- disneyland %>%
  filter(Branch == 'Disneyland_California', mention_ride == 1) %>%
  select(Review_ID,Review_Text)%>%
  group_by(Review_ID)%>%
  unnest_tokens(output=word,input=Review_Text)%>%
  inner_join(afinn)

agg_data <- aggregate(dis_w_shop[, 'value'], by = list(dis_w_shop$Review_ID), FUN = function(x) mean(x))

colnames(agg_data) <- c("Review_ID", "mean_value")
agg_data %>%
  ggplot(aes(x=mean_value,fill=mean_value>0))+
  geom_histogram(binwidth = 0.1)+
  scale_x_continuous(breaks=seq(-5,5,1))+
  scale_fill_manual(values=c('tomato','seagreen'))+
  theme_bw() +
  labs(x = "Review Sentiment Scores", y = "Number of Reviews") +
  ggtitle("Distribution of Review Sentiment in California Branch (contain ride experience)")


```

Distribution of sentiment scores without ride experience
```{r message=FALSE, warning=FALSE}
dis_wt_shop <- disneyland %>%
  filter(Branch == 'Disneyland_California', mention_ride == 0) %>%
  select(Review_ID,Review_Text)%>%
  group_by(Review_ID)%>%
  unnest_tokens(output=word,input=Review_Text)%>%
  inner_join(afinn)
agg_data <- aggregate(dis_wt_shop[, 'value'], by = list(dis_wt_shop$Review_ID), FUN = function(x) mean(x))

colnames(agg_data) <- c("Review_ID", "mean_value")
agg_data %>%
  ggplot(aes(x=mean_value,fill=mean_value>0))+
  geom_histogram(binwidth = 0.1)+
  scale_x_continuous(breaks=seq(-5,5,1))+
  scale_fill_manual(values=c('tomato','seagreen'))+
  theme_bw() +
  labs(x = "Review Sentiment Scores", y = "Number of Reviews") +
  ggtitle("Distribution of Review Sentiment in California Branch (not contain ride experience)")

```

### Paris
Distribution of sentiment scores with ride experience
```{r message=FALSE, warning=FALSE}
dis_w_shop <- disneyland %>%
  filter(Branch == 'Disneyland_Paris', mention_ride == 1) %>%
  select(Review_ID,Review_Text)%>%
  group_by(Review_ID)%>%
  unnest_tokens(output=word,input=Review_Text)%>%
  inner_join(afinn)

agg_data <- aggregate(dis_w_shop[, 'value'], by = list(dis_w_shop$Review_ID), FUN = function(x) mean(x))

colnames(agg_data) <- c("Review_ID", "mean_value")
agg_data %>%
  ggplot(aes(x=mean_value,fill=mean_value>0))+
  geom_histogram(binwidth = 0.1)+
  scale_x_continuous(breaks=seq(-5,5,1))+
  scale_fill_manual(values=c('tomato','seagreen'))+
  theme_bw() +
  labs(x = "Review Sentiment Scores", y = "Number of Reviews") +
  ggtitle("Distribution of Review Sentiment in Paris Branch (contain ride experience)")


```

Distribution of sentiment scores without ride experience
```{r message=FALSE, warning=FALSE}
dis_wt_shop <- disneyland %>%
  filter(Branch == 'Disneyland_Paris', mention_ride == 0) %>%
  select(Review_ID,Review_Text)%>%
  group_by(Review_ID)%>%
  unnest_tokens(output=word,input=Review_Text)%>%
  inner_join(afinn)
agg_data <- aggregate(dis_wt_shop[, 'value'], by = list(dis_wt_shop$Review_ID), FUN = function(x) mean(x))

colnames(agg_data) <- c("Review_ID", "mean_value")
agg_data %>%
  ggplot(aes(x=mean_value,fill=mean_value>0))+
  geom_histogram(binwidth = 0.1)+
  scale_x_continuous(breaks=seq(-5,5,1))+
  scale_fill_manual(values=c('tomato','seagreen'))+
  theme_bw() +
  labs(x = "Review Sentiment Scores", y = "Number of Reviews") +
  ggtitle("Distribution of Review Sentiment in Paris Branch (not contain ride experience)")

```

## Overall Sentiment Analytis
Calculate proportions and average scores required
```{r message=FALSE, warning=FALSE}
##### hong kong#####
# proportion of positive sentiment with shopping words
pos_prop_w_shop_hk <- disneyland %>%
  filter(Branch == 'Disneyland_HongKong', mention_ride == 1) %>%
  select(Review_ID, Review_Text) %>%
  unnest_tokens(output = word, input = Review_Text) %>%
  inner_join(afinn) %>%
  mutate(positive = ifelse(value >= 0, 1, 0)) %>%
  summarize(proportion_positive = sum(positive) / NROW(word))

#  proportion of positive sentiment without shopping words
pos_prop_wt_shop_hk <- disneyland %>%
  filter(Branch == 'Disneyland_HongKong', mention_ride == 0) %>%
  select(Review_ID, Review_Text) %>%
  unnest_tokens(output = word, input = Review_Text) %>%
  inner_join(afinn) %>%
  mutate(positive = ifelse(value >= 0, 1, 0)) %>%
  summarize(proportion_positive = sum(positive) / NROW(word))


# average sentiment score with shopping words
mean_w_shop_hk <- disneyland %>%
  filter(Branch == 'Disneyland_HongKong', mention_ride == 1) %>%
  select(Review_ID,Review_Text)%>%
  group_by(Review_ID)%>%
  unnest_tokens(output=word,input=Review_Text)%>%
  inner_join(afinn) %>%
  ungroup() %>%
  summarize(avg = mean(value))

# average sentiment score without shopping words
mean_wt_shop_hk <- disneyland %>%
  filter(Branch == 'Disneyland_HongKong', mention_ride == 0) %>%
  select(Review_ID,Review_Text)%>%
  group_by(Review_ID)%>%
  unnest_tokens(output=word,input=Review_Text)%>%
  inner_join(afinn) %>%
  ungroup() %>%
  summarize(avg = mean(value))


##### california #####
# proportion of positive sentiment with shopping words
pos_prop_w_shop_ca <- disneyland %>%
  filter(Branch == 'Disneyland_California', mention_ride == 1) %>%
  select(Review_ID, Review_Text) %>%
  unnest_tokens(output = word, input = Review_Text) %>%
  inner_join(afinn) %>%
  mutate(positive = ifelse(value >= 0, 1, 0)) %>%
  summarize(proportion_positive = sum(positive) / NROW(word))

#  proportion of positive sentiment without shopping words
pos_prop_wt_shop_ca <- disneyland %>%
  filter(Branch == 'Disneyland_California', mention_ride == 0) %>%
  select(Review_ID, Review_Text) %>%
  unnest_tokens(output = word, input = Review_Text) %>%
  inner_join(afinn) %>%
  mutate(positive = ifelse(value >= 0, 1, 0)) %>%
  summarize(proportion_positive = sum(positive) / NROW(word))

# average sentiment score with shopping words
mean_w_shop_ca <- disneyland %>%
  filter(Branch == 'Disneyland_California', mention_ride == 1) %>%
  select(Review_ID,Review_Text)%>%
  group_by(Review_ID)%>%
  unnest_tokens(output=word,input=Review_Text)%>%
  inner_join(afinn) %>%
  ungroup() %>%
  summarize(avg = mean(value))

# average sentiment score without shopping words
mean_wt_shop_ca <- disneyland %>%
  filter(Branch == 'Disneyland_California', mention_ride == 0) %>%
  select(Review_ID,Review_Text)%>%
  group_by(Review_ID)%>%
  unnest_tokens(output=word,input=Review_Text)%>%
  inner_join(afinn) %>%
  ungroup() %>%
  summarize(avg = mean(value))



##### paris #####
# proportion of positive sentiment with shopping words
pos_prop_w_shop_paris <- disneyland %>%
  filter(Branch == 'Disneyland_Paris', mention_ride == 1) %>%
  select(Review_ID, Review_Text) %>%
  unnest_tokens(output = word, input = Review_Text) %>%
  inner_join(afinn) %>%
  mutate(positive = ifelse(value >= 0, 1, 0)) %>%
  summarize(proportion_positive = sum(positive) / NROW(word))

#  proportion of positive sentiment without shopping words
pos_prop_wt_shop_paris <- disneyland %>%
  filter(Branch == 'Disneyland_Paris', mention_ride == 0) %>%
  select(Review_ID, Review_Text) %>%
  unnest_tokens(output = word, input = Review_Text) %>%
  inner_join(afinn) %>%
  mutate(positive = ifelse(value >= 0, 1, 0)) %>%
  summarize(proportion_positive = sum(positive) / NROW(word))

# average sentiment score with shopping words
mean_w_shop_paris <- disneyland %>%
  filter(Branch == 'Disneyland_Paris', mention_ride == 1) %>%
  select(Review_ID,Review_Text)%>%
  group_by(Review_ID)%>%
  unnest_tokens(output=word,input=Review_Text)%>%
  inner_join(afinn) %>%
  ungroup() %>%
  summarize(avg = mean(value))

# average sentiment score without shopping words
mean_wt_shop_paris <- disneyland %>%
  filter(Branch == 'Disneyland_Paris', mention_ride == 0) %>%
  select(Review_ID,Review_Text)%>%
  group_by(Review_ID)%>%
  unnest_tokens(output=word,input=Review_Text)%>%
  inner_join(afinn) %>%
  ungroup() %>%
  summarize(avg = mean(value))
```

Proportion of positive words in reviews w/wt shopping words
```{r message=FALSE, warning=FALSE}
# make proportion plot
df_prop = data.frame(branch = c('Hong Kong', 'California', 'Paris'),
                     prop_pos_words_w_shop = c(as.numeric(pos_prop_w_shop_hk), as.numeric(pos_prop_w_shop_ca), as.numeric(pos_prop_w_shop_paris)),
                     prop_pos_words_wt_shop = c(as.numeric(pos_prop_wt_shop_hk), as.numeric(pos_prop_wt_shop_ca), as.numeric(pos_prop_wt_shop_paris)))
df_prop_long <- tidyr::pivot_longer(df_prop, cols = c("prop_pos_words_w_shop", "prop_pos_words_wt_shop"), names_to = "category", values_to = "proportion")
ggplot(df_prop_long, aes(x = branch, y = proportion, fill = category)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7, color = "black", size = 0.5) +
  scale_fill_manual(values = c("#0072B2", "#F0E442"), 
                    labels=c("Mentioned", "Did not mention")) +
  labs(title = "Proportion of Positive Words with and without ride experience", x = "Branch", y = "Proportion", fill = 'Ride experience mentioned') +
  geom_text(aes(label=round(proportion, 2)), position=position_dodge(width=0.9), vjust=-0.25) +
theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title = element_text(size = 14, face = "bold"),
        legend.title = element_text(size = 12, face = "bold"),
        legend.text = element_text(size = 12))
```

Average sentiment scores of reviews w/wt shopping words
```{r message=FALSE, warning=FALSE}
# make average score plot
df_mean = data.frame(branch = c('Hong Kong', 'California', 'Paris'),
                     mean_w_shop = c(as.numeric(mean_w_shop_hk), as.numeric(mean_w_shop_ca), as.numeric(mean_w_shop_paris)),
                     mean_wt_shop = c(as.numeric(mean_wt_shop_hk), as.numeric(mean_wt_shop_ca), as.numeric(mean_wt_shop_paris)))
df_mean_long <- tidyr::pivot_longer(df_mean, cols = c("mean_w_shop", "mean_wt_shop"), names_to = "category", values_to = "proportion")
ggplot(df_mean_long, aes(x = branch, y = proportion, fill = category)) +
  geom_bar(stat = "identity", position = "dodge", width = 0.7, color = "black", size = 0.5) +
  scale_fill_manual(values = c("#0072B2", "#F0E442"), 
                    labels=c("Mentioned", "Did not mention")) +
  labs(title = "Average sentiment scores with and without ride experience", x = "Branch", y = "Average sentiment score", fill = 'Ride experience mentioned') +
  geom_text(aes(label=round(proportion, 2)), position=position_dodge(width=0.9), vjust=-0.25) +
theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title = element_text(size = 14, face = "bold"),
        legend.title = element_text(size = 12, face = "bold"),
        legend.text = element_text(size = 12))
```











<br>
<br>









### Discussions  
Hypo 1: 
By cleaning and tokenizing the review texts, we converted the texts to lower cases, removed urls, punctuations, stopwords, and white spaces, created dictionaries to complete the words back later, and removed sparse terms. Then, getting the most frequently mentioned words in the reviews by calculating and ranking the occurrence frequencies, we were able to discover topics that reviewers tend to mention and thus tend to care about in the three branches. Focusing on the shopping experiences and ride experiences related topics, we were able to discover consumer demands in these two aspects. We have further utilized ratings data and conducted sentiment analysis using afinn sentiment scores on these two general topics to discover consumer preferences and qualify their experiences and sentiments.  
We have noticed that for all three branches, the same mostly mentioned words are "kid", "park", "ride", and "wait". Reviewer that commented Hong Kong branch seemed to mention topics that are more general topics, like the park itself, food, parade, queue, and fireworks. For California branch, people seemed to have more to say about queue experiences, waiting time, about the visiting crowd or visitor amount, and probably the speed and efficiency taking rides during their visits. Reviewer's in Paris, however, seemed especially have more to say about their treatments and character meeting experiences. 

Hypo 2:

Hypo 3: 
11-16% of the total reviews mentioned about ride experiences for all three branches. However, the differences between branches' average ratings for those that mentioned rides and did not mention rides differ. In Hong Kong, the average rating is higher for those that mentioned ride than those that did not mention. However, although California branch tend to receive the highest ranking among all three branches, the average rating is higher for those that did not mention rides than those that mentioned. Paris tend to receive much lower average ratings compared with the other two, even regardless of mentioning rides or not. This might suggest that visitors are as satisfied about Paris branch in general as other branches, and the ride experiences might have related to such low ratings.   
The mostly mentioned ride in Hong Kong branch is Space_Mountain ride, following by Small_World and Haunted_Mansion. Reviews who mentioned Small_World, Haunted_Mansion, and Star_Tours tend to give higher ratings on average. In California, the mostly mentioned rides are Space_Mountain, Splash_Mountain, and Haunted_Mansion. Big-Thunder, Star_Tours, and Haunted_Mansion received the top ratings. However, those that did not mention any rides got same average ratings as Haunted_Mansion, which is higher than most rides that are mentioned more. This might suggest that California visitors might not be entirely satisfied with the most popular rides and gave relatively lower ratings. For Paris branch, the mostly mentioned rides are Space_Mountain ride, Pirates, and Star_Tours. Peter_Pan and Small_World received similarly higher average ratings, following by Space_Mountain. People tend not to give higher ratings when they mention rides that are popular or mostly mentioned compared with the ratings without mentioning rides, in which case, these most mentioned rides tend not to be more favorable among visitors. 




### Recommendation:  
Shopping related recommendations:
In rating analysis, reviews of the Hong Kong branch mentions products such as toy, book and souvenir the most, and these words all received higher rating, while other products like bag and hat received relatively lower rating, which could be a direction for improvement. 
Reviews of the California branch mentions book, bag and souvenir the most, but these all received lower ratings, which might indicate that these products received more complaints and need to be improved. 
Reviews of the Paris branch focus much more on book, and bag are the secondly most frequent word. 
Overall, "book", "toy" and "bag" are more commonly mentioned in all reviews. However, while "book" could have other meanings like booking an hotel, "toy" and "bag" should be the products that Disneyland should focus more on. An interesting point is that, even though the California branch received the least reviews about shopping, its ratings related to shopping's relatively higher, so the California branch can advertise on the the shopping segment to earn more attention. On the other hand, Paris received the most shopping reviews, but its average rating on shopping words are much lower. The Paris branch could try to improve its shopping experience given the spotlight. 
In sentiment analysis, we observed that all three branches had lower proportion of positive words and lower average sentiment scores for reviews that are related to shopping. This fact partially indicates that there are more people complaining when they talk about shopping. Thus, all branches should put more emphasis on improving the shopping segment.

Rides related recommendations: 
We recommend Hong Kong branch to maintain and improve the rides services for Small_World, Haunted_Mansion, and Star_Tours, as these 3 rides gained the most attentions from reviewers and tend to generate higher ratings.  
For California branch, we recommend to maintain and improve the ride services that with high ratings: Big-Thunder and Star_Tours. With the high average ratings, these two rides have potentials to be exploited. More marketing practices are recommended to introduce these two rides grab more attention from potential consumers. Moreover, we also suggest to improve ride services for the mostly mentioned rides: Space_Mountain, Splash_Mountain, and Haunted_Mansion. These three rides are the mostly mentioned attractions but did not tend to be more favorable, even receiving same or lower average ratings than reviews did not mention any ride. Improving the ride services for these three could potentially improve consumer ratings and leave more positive impressions.  
As for Paris branch, we recommend to maintain and improve the ride services that with high ratings: Peter_Pan and Small_World. With the high average ratings, these two rides have potentials to be exploited. More marketing practices are recommended to introduce these two rides grab more attention from potential consumers. Secondly, improve ride services for the mostly mentioned rides: Space_Mountain, Pirates, and Star_Tours. These 3 rides tend to receive the most attentions from visitors. Improving the services for these rides will attract the most amount of customers, and improve the rating performances in relatively bigger scale. Last but not least, as mentioned before, Paris branch tends to receive significantly lower ratings compared with the other two branches. This resembles to the rating performances in its rides. Therefore, we could assume that one potential cause of the low general rating in Paris branch is the unfavorable ride experiences. More adjustments and considerations should be made to the entire branchâ€™s general ride experiences.  
Regarding sentiment analysis, the difference in proportion of positive words between reviews with ride experience or not is ambiguous, but the average sentiment score for ride-related reviews are much lower, indicating that reviewers may have more extreme emotions toward ride experience. Thus, every branch should examine each of their ride services and make improvements accordingly. 


### Limitation:  
We have only selected two major topics, shopping and ride experiences, to do investigations in this study. Other topics like kids and children experiences, interactions with characters, and fireworks, etc. These might also become important factors and topics that visitors care about and thus to give ratings.  



### Future Study:  
Future study could consider selecting more topics and to investigate the impact that may have on visitor ratings. For example, kids and children experiences, interactions with characters, and fireworks, etc. 

















